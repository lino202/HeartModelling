function [sigma sigma0]=noise_M2(I,N,Nb)

M2=filter2(ones(N)./(N.^2-1),I.^2);


sigma0=0.5.*moda(M2(:),Nb);
fc=4.*sigma0;


[h,x]=hist(M2(M2<fc),Nb);
h=h./sum(h)./(x(2)-x(1));
N2=N.^2;

fu_x=@(y)sum((h-y(1).*x.^(N.^2-1).*exp(-x.*(N^2)./y(2))./gamma(N^2)./(y(2)./(N^2)).^(N^2)).^2);
X=fminsearch(fu_x,[1,sigma0]);

sigma=sqrt(0.5*X(2));
sigma0=sqrt(sigma0);
